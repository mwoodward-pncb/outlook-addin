<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACGI Email Helper • Stable Step 1 (Clipboard-safe)</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    onload="console.log('Office.js loaded')"
    onerror="console.error('Office.js failed to load')"></script>
  <style>
    body { font-family: Segoe UI, Tahoma, Arial, sans-serif; margin: 0; padding: 14px; background: #f5f5f5; }
    .card { background:#fff; border:1px solid #e1e1e1; border-radius:8px; padding:14px; margin-bottom:10px; }
    h2 { font-size:16px; margin:0 0 8px 0; color:#2b2b2b; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .label { width:82px; color:#444; font-weight:600; }
    .value { flex:1; word-break:break-word; }
    .btn { background:#0078d4; color:#fff; border:none; padding:10px 14px; border-radius:4px; cursor:pointer; font-size:13px; }
    .btn.secondary { background:#605e5c; }
    .btn.inline { padding:6px 10px; font-size:12px; }
    .muted { color:#666; font-size:12px; }
    .mono { font-family:Consolas, monospace; font-size:12px; }
    textarea { width:100%; min-height:110px; border:1px solid #ddd; border-radius:6px; padding:10px; resize:vertical; }
    input.readonly { width:100%; border:1px solid #ddd; border-radius:6px; padding:8px; font-family:Consolas, monospace; font-size:12px; }
    #log { background:#0e0f10; color:#e8e8e8; border:1px solid #2b2c2d; height:160px; overflow:auto; padding:8px; border-radius:6px; font-family:Consolas, monospace; font-size:12px; }
    .pill { display:inline-block; background:#f3f2f1; border:1px solid #e1e1e1; padding:2px 6px; border-radius:12px; margin:2px; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Environment</h2>
    <div class="row">
      <span class="pill" id="host">Host: —</span>
      <span class="pill" id="platform">Platform: —</span>
      <span class="pill" id="mb13">Mailbox 1.3: —</span>
      <span class="pill" id="now">—</span>
    </div>
  </div>

  <div class="card">
    <h2>Step 1: Load email data</h2>
    <div class="row" style="justify-content:space-between;">
      <button class="btn" id="btnLoad">Load Email</button>
      <button class="btn secondary" id="btnClear">Clear</button>
    </div>
    <div id="log"></div>
  </div>

  <div class="card">
    <h2>Captured fields</h2>
    <div class="row"><div class="label">Subject</div><div class="value" id="subj">—</div></div>
    <div class="row"><div class="label">From</div><div class="value" id="from">—</div></div>
    <div class="row"><div class="label">To</div><div class="value" id="to">—</div></div>
    <div class="row"><div class="label">Cc</div><div class="value" id="cc">—</div></div>
    <div class="row"><div class="label">Date</div><div class="value" id="date">—</div></div>
    <div class="row"><div class="label">Attachments</div><div class="value" id="atts">—</div></div>
  </div>

  <div class="card">
    <h2>Suggested PDF filename</h2>
    <div class="row" style="width:100%">
      <input id="fileName" class="readonly" readonly value="—" />
      <div class="row">
        <button class="btn inline" id="copyNameBtn">Copy</button>
        <button class="btn secondary inline" id="selectNameBtn">Select</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Draft Long Description</h2>
    <textarea id="desc"></textarea>
    <div class="row" style="justify-content:space-between;">
      <span class="muted">Edit before copying if needed.</span>
      <div class="row">
        <button class="btn secondary inline" id="regenBtn">Rebuild</button>
        <button class="btn inline" id="copyDescBtn">Copy</button>
        <button class="btn secondary inline" id="selectDescBtn">Select all</button>
      </div>
    </div>
  </div>

<script>
  const logEl = document.getElementById('log');
  function log(){ const s=[...arguments].map(x => typeof x==='object'?JSON.stringify(x):String(x)).join(' ');
    const ts=new Date().toLocaleTimeString(); logEl.textContent += '['+ts+'] '+s+'\n'; logEl.scrollTop = logEl.scrollHeight; }

  function setText(el, txt){ if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){ el.value = txt; } else { el.textContent = txt; } }

  function selectElement(el){
    if(el.select){ el.focus(); el.select(); return true; }
    const range = document.createRange(); range.selectNodeContents(el);
    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    return true;
  }

  async function writeClipboardFallback(text){
    // Try navigator.clipboard first
    try{
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){
      log('navigator.clipboard blocked:', e.message);
    }
    // Fallback to execCommand
    try{
      const ta = document.createElement('textarea');
      ta.style.position = 'fixed'; ta.style.opacity='0'; ta.value = text;
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      log('execCommand copy failed:', e.message);
      return false;
    }
  }

  function safe(v){ return v || ''; }
  function joinAddrs(arr){ return (arr || []).map(a => a.displayName ? a.displayName + ' <' + a.emailAddress + '>' : a.emailAddress).join('; '); }
  function sanitizeForFileName(s){
    if(!s) return 'email'; const cleaned = s.replace(/[\\/:*?"<>|]+/g, ' ').replace(/\s+/g,' ').trim(); return cleaned.substring(0,80);
  }
  function ts(dt){ try{ const d=new Date(dt); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;}catch(_){return 'date';} }
  function suggestFileName(state){
    const base = `PNCB_Email_${ts(state.dateTime)}_${sanitizeForFileName(state.fromEmail || state.fromDisplay)}_${sanitizeForFileName(state.subject)}`;
    return base + '.pdf';
  }
  function buildDescription(state){
    const lines = [];
    lines.push(`Email Subject: ${safe(state.subject)}`);
    lines.push(`From: ${safe(state.fromDisplay)} <${safe(state.fromEmail)}>`);
    if(state.to) lines.push(`To: ${state.to}`);
    if(state.cc) lines.push(`Cc: ${state.cc}`);
    lines.push(`Received: ${state.dateLocal}`);
    lines.push('');
    if(state.bodyText){ lines.push(state.bodyText.replace(/\\s+/g,' ').trim().substring(0, 600)); }
    else { lines.push('(Body not loaded.)'); }
    lines.push('');
    lines.push('Attachments: ' + (state.attachList || '(none)'));
    return lines.join('\\n');
  }
  function backoff(attempt){ return Math.min(1500, 200 * Math.pow(2, attempt)); }

  async function getBodyWithRetry(item, max=4){
    return new Promise((resolve) => {
      let tries = 0;
      const attempt = () => {
        tries++;
        item.body.getAsync(Office.CoercionType.Text, (res) => {
          if(res.status === Office.AsyncResultStatus.Succeeded){
            resolve(res.value || '');
          } else if (tries < max){
            log('Body getAsync failed, retrying...', res.error && res.error.name || res.status);
            setTimeout(attempt, backoff(tries));
          } else {
            log('Body getAsync failed, giving up:', res.error && res.error.message || res.status);
            resolve('');
          }
        });
      };
      attempt();
    });
  }

  async function collectData(){
    const state = {};
    const item = Office.context.mailbox && Office.context.mailbox.item;
    if(!item){ throw new Error('No item context'); }

    state.subject = safe(item.subject);
    const sender = item.sender || {};
    state.fromDisplay = safe(sender.displayName);
    state.fromEmail = safe(sender.emailAddress);
    state.to = joinAddrs(item.to ? item.to : item.toRecipients);
    state.cc = joinAddrs(item.cc ? item.cc : item.ccRecipients);
    state.dateTime = item.dateTimeCreated || item.dateTimeModified || new Date().toISOString();
    state.dateLocal = new Date(state.dateTime).toLocaleString();

    const atts = item.attachments || [];
    state.attachList = atts.length ? atts.map(a => a.name).join(', ') : '';

    state.bodyText = await getBodyWithRetry(item);
    return state;
  }

  function render(state){
    setText(document.getElementById('subj'), state.subject || '(no subject)');
    setText(document.getElementById('from'), state.fromDisplay || state.fromEmail || '(unknown)');
    setText(document.getElementById('to'), state.to || '(none)');
    setText(document.getElementById('cc'), state.cc || '(none)');
    setText(document.getElementById('date'), state.dateLocal || '(unknown)');
    setText(document.getElementById('atts'), state.attachList || '(none)');
    setText(document.getElementById('fileName'), suggestFileName(state));
    document.getElementById('desc').value = buildDescription(state);
  }

  // Office bootstrap
  Office.onReady((info) => {
    document.getElementById('host').textContent = 'Host: ' + (info && info.host ? info.host : '(unknown)');
    document.getElementById('platform').textContent = 'Platform: ' + (info && info.platform ? info.platform : '(unknown)');
    const mb13 = Office.context && Office.context.requirements && Office.context.requirements.isSetSupported('Mailbox','1.3');
    document.getElementById('mb13').textContent = 'Mailbox 1.3: ' + (mb13 ? 'Yes' : 'No');
    document.getElementById('now').textContent = new Date().toLocaleString();
    log('Office.onReady fired', JSON.stringify(info));
  });

  // Buttons
  let LAST = null;
  document.getElementById('btnLoad').onclick = async () => {
    log('Loading email...');
    try{
      const state = await collectData();
      LAST = state;
      render(state);
      log('Email loaded.');
    } catch(e){
      log('Load failed:', e.message);
    }
  };
  document.getElementById('btnClear').onclick = () => { logEl.textContent=''; };
  document.getElementById('regenBtn').onclick = () => { if(LAST){ document.getElementById('desc').value = buildDescription(LAST); } };
  document.getElementById('copyNameBtn').onclick = async () => {
    const txt = document.getElementById('fileName').value || '';
    const ok = await writeClipboardFallback(txt);
    log(ok ? 'Filename copied.' : 'Copy failed. Use Select then Ctrl+C.');
  };
  document.getElementById('copyDescBtn').onclick = async () => {
    const txt = document.getElementById('desc').value || '';
    const ok = await writeClipboardFallback(txt);
    log(ok ? 'Description copied.' : 'Copy failed. Use Select all then Ctrl+C.');
  };
  document.getElementById('selectNameBtn').onclick = () => { selectElement(document.getElementById('fileName')); };
  document.getElementById('selectDescBtn').onclick = () => { document.getElementById('desc').focus(); document.getElementById('desc').select(); };
</script>
</body>
</html>
